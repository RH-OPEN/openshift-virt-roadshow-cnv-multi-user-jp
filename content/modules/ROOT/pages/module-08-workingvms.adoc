= 仮想マシンとアプリケーション

== はじめに

このセクションでは、多くの管理者が OpenShift 仮想化環境で仮想マシンを操作する際に必要となる Day-2 の操作について説明します。このロードショーを通して培った、OpenShift 環境で VM がどのように動作するかについての理解を活用し、このセクションのタスクを完了するためにそれらのスキルを使用します。この特定のケースでは、このロードショーで以前に VMware vSphere からインポートした 3 つの仮想マシンを使って作業し、OpenShift Virtualization で現在実行されているように、これらのサーバー上でホストされているアプリケーションにアクセスできるようにするために、いくつかの小さな設定変更を行うつもりです。これを達成するために、OpenShift SDN ポッドネットワークを利用するときのデフォルトである service/route メソッドを使ってアプリケーションを公開し、アプリケーションがクラスタの外から到達できるようにします。

[[service_route]]
== サービス/ルートでアプリケーションを公開する

デフォルトでは、仮想マシンは SDN に接続されており、残りのネットワークにアクセスするための便利で簡単な方法ですが、仮想マシンや OpenShift クラスタ内の他のポッドが仮想化アプリケーションを見つけて接続するのは難しいかもしれません。これを解決するために、2つのWindowsベースのWebサーバー間で接続のバランスをとるために *Service* を使用し、各サービスディスカバリーのDNSエントリーを作成し、外部クライアントが仮想マシン内でホストされているアプリケーションにアクセスできるように *Route* を作成します。

IMPORTANT: 「既存の仮想マシンの移行」モジュールを完了していない場合は、そのモジュールを最初に実行することをお勧めします。このモジュールが完了していない場合、または移行プロセスがまだ保留中の場合は、*vmimported* プロジェクトで利用可能な既存の仮想マシンを使用できます。これらのインポート済み仮想マシンを使用する場合は、以下の例の *vmexamples* ネームスペースのインスタンスをすべて *vmimported* に置き換えてください。

=== サービスの紹介

*Services* は、ラベルに基づいてトラフィックのソース/ターゲットを特定し、クライアントをエンドポイントに誘導します。現在、VMにはまだラベルが割り当てられていない。

VMをサービスとうまく関連付けるには、以下のことを行う必要がある:

* VMにラベルを追加する。VMにラベルを追加する。両方のWindows IISサーバーは同じロードバランサーの後ろにあるため、同じラベルを使用する。
* 2つのWindows IISサーバーをクラスタ上の他のワークロードで利用できるようにするためにサービスを作成します。OpenShift は自動的に DNS 名としてサービス名を使用してロードバランサーを内部的にアクセス可能にします。
* *ルート* を作成することで、OpenShift の外部でサービスを利用できるようにします。

まず始めに、OpenShift Virtualization GUI で仮想マシンの定義を変更することで、仮想マシンにラベルを追加します。

=== 仮想マシンにラベルを付ける

. OpenShift コンソールから *Virtualization* -> *VirtualMachines* に移動し、移行した VM が正常にインポートされ、実行されていることを確認します。
+
image::module-08-workingvms/11_Imported_VMs_List.png[link=self, window=blank, width=100%]
+
NOTE: *Migrating Existing Virtual Machines* モジュールを完了した場合は *vmexamples-{user}* 、完了していない場合は *vmimported-{user}* と、正しいプロジェクトを選択していることを確認してください。

. *winweb01* VMを選択し、*YAML* タブに移動します。
. *spec:* セクションを見つけ、*template.metadata* セクションの下の VM リソースの *labels* セクションに以下の行を追加します：
+
[source,yaml,role=execute]
----
env: webapp
----
+

IMPORTANT: 以下のスクリーンショットのように、インデントを正確にすること。
+
image::module-08-workingvms/12_Imported_VMs_YAML.png[link=self, window=blank, width=100%]

. VM *winweb02* のプロセスを繰り返す。
. まだ実行中でなければ、*database* 仮想マシンを起動する。
. *winweb01* および *winweb02* 仮想マシンを起動します。
+
NOTE: 各仮想マシンのコンソールタブにアクセスして、仮想マシンが正しく動作していることを確認します。

=== サービスの作成

. *Networking* -> *Services* に移動し、*Create Service* を押します。
+
image::module-08-workingvms/13_Navigate_Service.png[link=self, window=blank, width=100%]

. YAMLを以下の定義に置き換える
+
[source,yaml,role=execute,subs="attributes"]
----
apiVersion: v1
kind: Service
metadata:
  name: webapp
  namespace: vmexamples-{user}
spec:
  selector:
    env: webapp
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
----
+
IMPORTANT: *vmexamples-{user}* または *vmimported-{user}* という仮想マシンの *nameespace* が、サービス YAML で使用されているものであることを確認してください。
+
image::module-08-workingvms/14_Service_YAML.png[link=self, window=blank, width=100%]

. *Create* を押します。
. 新しく作成された *webapp* サービスの詳細ページから、*Podセレクタ* リンクを探し、クリックします。
+
image::module-08-workingvms/15_Imported_VMs_PodSelector.png[link=self, window=blank, width=100%]

. 2つのWindows VMが適切に識別され、サービスのターゲットになっていることを確認します。
+
image::module-08-workingvms/16_Imported_VMs_Pods.png[link=self, window=blank, width=100%]

=== ルートの作成

これで、OpenShiftクラスタ内からWindows IISサーバにアクセスできるようになりました。他の仮想マシンは、サービス名 + ネームスペースで決まる DNS 名 *webapp.vmexamples* を使ってアクセスできます。しかし、これらの Web サーバーは外部からアクセスできるようにしたいアプリケーションのフロントエンドなので、*Route* を使って公開します。

. 左のナビゲーション・メニューから *Networking* -> *Routes* に移動し、正しいプロジェクト名を使用していることを確認します。*Create Route* を押します。
+
image::module-08-workingvms/17_Route_Navigation.png[link=self, window=blank, width=100%]

. 以下の情報をフォームに入力し、完了したら *Create* を押します。
+
.. *Name*: *route-webapp*
.. *Service*: *webapp*
.. *Target port*: *80 -> 80 (TCP)*
.. *Secure Route*: *Enabled*
.. *TLS termination*: *Edge*
.. *Insecure traffic*: *Redirect*
+
image::module-08-workingvms/18_Create_Route.png[link=self, window=blank, width=100%]

. *Location* フィールドに表示されているアドレスに移動します。
+
image::module-08-workingvms/19_Route_Access.png[link=self, window=blank, width=100%]

. ページがロードされると、エラーが表示されます。これは、Windowsウェブサーバーが移行後のデータベースVMに現在接続できないためです。
+
image::module-08-workingvms/20_WebApp_Error.png[link=self, window=blank, width=100%]
+
NOTE: 接続性の問題を解決するには、データベースVM用のサービスを作成して、ウェブサーバーからアクセスできるようにする必要があります。

. もう一度、*Networking* -> *Services* に移動し、*Create Service* を押す。YAMLを以下の定義に置き換える:
+
[source,yaml,role=execute,subs="attributes"]
----
apiVersion: v1
kind: Service
metadata:
  name: database
  namespace: vmexamples-{user}
spec:
  selector:
    vm.kubevirt.io/name: database
  ports:
  - protocol: TCP
    port: 3306
    targetPort: 3306
----
+
NOTE: 今回、作成するサービスにアタッチするために仮想マシンの名前を使用しました。この名前を持つネームスペースには *database* という名前の VM が 1 つしかないので、VM の YAML をカスタマイズしたりゲストを再起動したりしなくても安全です。
+
image::module-08-workingvms/21_Database_YAML.png[link=self, window=blank, width=100%]

. YAMLが貼り付けられたら、*Create* ボタンをクリックする。
+
IMPORTANT: 仮想マシンの名前空間 *vmexamples-{user}* または *vmimported-{user}* がサービス YAML で使用されているものであることを確認してください。
+
. ウェブアプリのURLをリロードし、適切な結果が得られることを期待します。
+
image::module-08-workingvms/22_WebApp_Success.png[link=self, window=blank, width=100%]

== まとめ

このモジュールでは、VMware vSphere から OpenShift Virtualization 環境に移行した仮想マシンを、様々な方法でクラスタ外からアクセスできるようにすることで、その作業を体験していただきました。

OpenShift仮想化ロードショーとそれに伴うこのラボを楽しんでいただけたなら幸いです。あなたの経験についてのフィードバックを提供するために、プロクターが用意したアンケートリンクに記入してください。