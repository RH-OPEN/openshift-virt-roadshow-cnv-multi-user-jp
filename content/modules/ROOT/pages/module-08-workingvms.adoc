= 仮想マシンとアプリケーション

== はじめに

このセクションでは、多くの管理者が OpenShift 仮想化環境で仮想マシンを操作する際に必要となる Day-2 オペレーションについて説明します。このロードショーを通して培った OpenShift 環境で VM がどのように動作するかについての理解を活用し、このセクションのタスクを完了するためにそれらのスキルを使用します。
この特定のケースでは、このロードショーで以前に VMware vSphere からインポートした 3 つの仮想マシンを使って作業し、OpenShift Virtualization で現在実行されているように、これらのサーバー上でホストされているアプリケーションにアクセスできるようにするために、いくつかの小さな設定変更を行います。
これを達成するために、OpenShift SDN ポッドネットワークを利用するときのデフォルトである service/route メソッドを使ってアプリケーションを公開し、アプリケーションがクラスタの外から到達できるようにします。

[[service_route]]
== Service/Routeを使用してアプリケーションを公開する

デフォルトでは、仮想マシンは SDN に接続されています。これはネットワークにアクセスするための便利で簡単な方法ですが、仮想マシンや OpenShift クラスタ内の他のポッドがVM上のアプリケーションを見つけて接続するのは難しいかもしれません。
これを解決するために、2つのWindowsベースのWebサーバー間で接続のバランスをとるために *Service* を使用し、各ServiceディスカバリーのDNSエントリーを作成し、外部クライアントが仮想マシン内でホストされているアプリケーションにアクセスできるように *Route* を作成します。

IMPORTANT: 「既存の仮想マシンの移行」モジュールを完了していない場合は、そのモジュールを最初に実行することをお勧めします。このモジュールが完了していない場合、または移行プロセスがまだ保留中の場合は、*vmimported* プロジェクトで利用可能な既存の仮想マシンを使用できます。これらのインポート済み仮想マシンを使用する場合は、以下の例の *vmexamples* ネームスペースのインスタンスをすべて *vmimported* に置き換えてください。

=== Serviceの紹介

*Service* は、ラベルに基づいてトラフィックのソース/ターゲットを特定し、クライアントをエンドポイントに誘導します。現在、VMにはまだラベルが割り当てられていません。

VMをServiceとうまく関連付けるには、以下のことを行う必要があります:

* VMにラベルを追加します。両方のWindows IISサーバーは同じロードバランサーの背後にあるため、同じラベルを指定します。
* クラスター上の他のワークロードのために、2つのWindows IISサーバーを利用可能にするServiceを作成します。
OpenShiftは自動的にDNS名としてService名を使用してロードバランサーを内部的にアクセス可能にします。
* *Route* を作成し、OpenShift の外部でServiceを利用できるようにします。

まず始めに、OpenShift Virtualization GUI で仮想マシンの定義を変更することで、仮想マシンにラベルを追加します。

=== 仮想マシンにラベルを付ける

. OpenShift コンソールから *Virtualization* -> *VirtualMachines* に移動し、移行した VM が正常にインポートされ、実行されていることを確認します。
+
image::module-08-workingvms/11_Imported_VMs_List.png[link=self, window=blank, width=100%]
+
NOTE: *Migrating Existing Virtual Machines* モジュールを完了した場合は *vmexamples-{user}* 、完了していない場合は *vmimported-{user}* と、正しいプロジェクトを選択していることを確認してください。

. *winweb01-{user}* VMを選択し、*YAML* タブに移動します。
. *spec:* セクションを見つけ、*template.metadata* セクション下の *labels* セクションに以下の行を追加します：
+
[source,yaml,role=execute]
----
env: webapp
----
+

IMPORTANT: 以下のスクリーンショットのように、インデントを正確に記載してください。
+
image::module-08-workingvms/12_Imported_VMs_YAML.png[link=self, window=blank, width=100%]

. VM *winweb02-{user}* に対し同じ作業を実施します。
. まだ実行中でなければ、*database-{user}* 仮想マシンを起動します。
. *winweb01-{user}* および *winweb02-{user}* 仮想マシンを起動します。
+
NOTE: 各仮想マシンのコンソールタブにアクセスして、仮想マシンが正しく動作していることを確認します。

[[create_service]]
=== Serviceの作成

. *Networking* -> *Services* に移動し、*Create Service* を押します。
+
image::module-08-workingvms/13_Navigate_Service.png[link=self, window=blank, width=100%]

. YAMLを以下の定義に書き換えます。
+
[source,yaml,role=execute,subs="attributes"]
----
apiVersion: v1
kind: Service
metadata:
  name: webapp
  namespace: vmexamples-{user}
spec:
  selector:
    env: webapp
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
----
+
IMPORTANT: *vmexamples-{user}* または *vmimported-{user}* という仮想マシンの *nameespace* が、Service YAML で使用されているものであることを確認してください。
+
image::module-08-workingvms/14_Service_YAML.png[link=self, window=blank, width=100%]

. *Create* を押します。
. 新しく作成された *webapp* Serviceの詳細ページから、*Pod selector* リンクを探し、クリックします。
+
image::module-08-workingvms/15_Imported_VMs_PodSelector.png[link=self, window=blank, width=100%]

. 2つのWindows VMが適切に識別され、Serviceのターゲットになっていることを確認します。
+
image::module-08-workingvms/16_Imported_VMs_Pods.png[link=self, window=blank, width=100%]

[[create_route]]
=== Routeの作成

これで、OpenShiftクラスタ内からWindows IISサーバにアクセスできるようになりました。他の仮想マシンは、Service名 + ネームスペースで決まる DNS 名 *webapp.vmexamples* を使ってアクセスできます。
ただし、これらの Web サーバーはアプリケーションのフロントエンドであるため、外部からアクセスできるようにする必要があります。これは、 *Route* を使用して公開することで実現します。

. 左のナビゲーション・メニューから *Networking* -> *Routes* に移動し、正しいプロジェクト名を使用していることを確認のうえ、*Create Route* を押します。
+
image::module-08-workingvms/17_Route_Navigation.png[link=self, window=blank, width=100%]

. 以下の情報をフォームに入力し、完了したら *Create* を押します。
+
.. Name: *route-webapp*
.. Service: *webapp*
.. Target port: *80 -> 80 (TCP)*
.. Secure Route: *Enabled*
.. TLS termination: *Edge*
.. Insecure traffic: *Redirect*
+
image::module-08-workingvms/18_Create_Route.png[link=self, window=blank, width=100%]

. *Location* フィールドに表示されているアドレスに移動します。
+
image::module-08-workingvms/19_Route_Access.png[link=self, window=blank, width=100%]

. ページがロードされるとエラーが表示されます。これは、現時点でWindowsウェブサーバーが移行後のデータベースVMに接続できないためです。
+
image::module-08-workingvms/20_WebApp_Error.png[link=self, window=blank, width=100%]
+
NOTE: 接続性の問題を解決するには、データベースVM用のServiceを作成して、ウェブサーバーからアクセスできるようにする必要があります。

. もう一度、*Networking* -> *Services* に移動し、*Create Service* を押します。YAMLを以下の定義に置き換えます:
+
[source,yaml,role=execute,subs="attributes"]
----
apiVersion: v1
kind: Service
metadata:
  name: database
  namespace: vmexamples-{user}
spec:
  selector:
    vm.kubevirt.io/name: database-{user}
  ports:
  - protocol: TCP
    port: 3306
    targetPort: 3306
----
+
NOTE: 今回、作成するServiceにアタッチするために仮想マシンの名前を使用しました。この名前を持つネームスペースには *database-{user}* という名前の VM が 1 つしかないので、VM の YAML をカスタマイズしたりゲストを再起動したりしなくても安全です。
+
image::module-08-workingvms/21_Database_YAML.png[link=self, window=blank, width=100%]

. YAMLが貼り付けられたら、*Create* ボタンをクリックする。
+
IMPORTANT: 仮想マシンのプロジェクト *vmexamples-{user}* または *vmimported-{user}* がService YAML で使用されているものであることを確認してください。
+
. ウェブアプリのURLをリロードし、適切な結果が得られることを期待します。
+
image::module-08-workingvms/22_WebApp_Success.png[link=self, window=blank, width=100%]

== まとめ

このモジュールでは、VMware vSphere から OpenShift Virtualization 環境に移行した仮想マシンを、様々な方法でクラスタ外からアクセスできるようにすることで、その作業を体験していただきました。

OpenShift仮想化ロードショーとそれに伴うこのラボを楽しんでいただけたなら幸いです。あなたの経験についてのフィードバックを提供するために、プロクターが用意したアンケートリンクに記入してください。