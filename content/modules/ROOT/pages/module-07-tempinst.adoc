= テンプレートとインスタンスタイプの管理

== はじめに

設定済みの Red Hat 仮想マシンテンプレートは、*Virtualization* -> *Templates* ページに一覧表示されています。これらのテンプレートは、Red Hat Enterprise Linux、Fedora、CentOS、Microsoft Windows Desktop、および Microsoft Windows Server の各エディションで使用できます。各 Red Hat 仮想マシンテンプレートは、オペレーティングシステムイメージ、オペレーティングシステムのデフォルト設定、フレーバー (CPU とメモリー)、およびワークロードタイプ (サーバー) で事前に構成されています。

*Templates* ページには、4 種類の仮想マシンテンプレートが表示されます：

* *Red Hat Supported* テンプレートは Red Hat によって完全にサポートされています。
* *Red Hat Supported* テンプレートは Red Hat によって完全にサポートされています。
* *Red Hat Provided* テンプレートは、Red Hat によって限定的にサポートされます。
* *User Provided* テンプレートは、ユーザーがクローンして作成した *Red Hat Provided* テンプレートです。

[[prepare_templates_lab]] 
== ラボの準備

. これから実行するタスクでは、いくつかの追加の VM をプロビジョニングする必要があります。準備として、既存の *fedora01* と *fedora02* 仮想マシンをシャットダウンして、共有環境にラボを完了するのに十分なリソースがあることを確認してください。

. *仮想化* -> *仮想マシン* に移動します。
. 環境内のすべての VM を確認するために、アクセスできるすべてのプロジェクトを確認してください。最低限、プロジェクト `vmimported-{user}` と `vmexamples-{user}` を確認してください。
. ステータスが *Running* となっているVMがあれば、右側の3つの点をクリックして *Stop* を選択してください。

これで全てのVMが *Stop* 状態になるはずだ。

[[clone_customize_template]]
== テンプレートのクローンとカスタマイズ

デフォルトでは、Red Hat OpenShift Virtualization が提供するテンプレートはカスタマイズできません。しかし、特定のワークロードに対して特定のタイプの仮想マシンを要求しやすくするために、テンプレートをクローンして特定のワークロード用に調整することができます。このラボのこのセクションでは、エンドユーザーに対してオンデマンドで事前設定済みのデータベースサーバーを提供するテンプレートを作成することで、まさにこれを実行します。

. 開始するには、*Virtualization* -> *Templates* に移動し、プロジェクトに *openshift* を選択します（ *Project* ドロップダウンを開き、*Show default projects* の横にあるラジオボタンをクリックする必要があるかもしれません）。
+
image::module-07-tempinst/01_Template_List.png[link=self, window=blank, width=100%]

. 検索バーに「*centos9*」と入力し、表示されたテンプレートの一覧から「*centos-stream9-server-small*」のテンプレートを見つけます。
+
image::module-07-tempinst/02_Search_Centos9.png[link=self, window=blank, width=100%]

. *centos-stream90-server-small* のテンプレート名をクリックすると、デフォルトテンプレートは編集できないというメッセージが表示され、クローンを作成するかどうか尋ねられます。*新しいカスタムテンプレートを作成する* オプションをクリックします。
+

image::module-07-tempinst/03_Create_Custom_Template.png[link=self, window=blank, width=100%]

. *テンプレートのクローン* という新しいメニューが表示されるので、以下の値を入力し、完了したら[*クローン*]ボタンをクリックします。
+
* テンプレート名:* centos-stream9-server-db-small
* テンプレートプロジェクト:* vmexamples-{user}
* *テンプレート表示名:* CentOS Stream 9 VM - Database Template Small
+
image::module-07-tempinst/04_Clone_Template_Options.png[link=self, window=blank, width=100%]

. これでテンプレートの *詳細* ページに移動し、いくつかのオプションをカスタマイズできるようになります。まず、ページの一番下にあるCPUとメモリを探し、鉛筆のアイコンをクリックして編集します。
+
image::module-07-tempinst/05_Clone_Details.png[link=self, window=blank, width=100%]

. 新しいウィンドウが表示され、CPUとメモリの量を編集できます。私たちのカスタムテンプレートでは、CPUsの値を2、Memoryの値を4 GiBに設定し、 *Save* ボタンをクリックします。
+
image::module-07-tempinst/06_Edit_CPU_Mem.png[link=self, window=blank, width=100%]

. 次に上部の *Scripts* タブをクリックし、*Cloud-init* というセクションで *Edit* ボタンをクリックします。
+
image::module-07-tempinst/09_Scripts_CloudInit.png[link=self, window=blank, width=100%]

. *Cloud-init* ダイアログが開いたら、ラジオボタンをクリックして *Configure via： Script* をクリックし、YAMLを以下のYAMLスニペットで置き換える。
+
[source,yaml,role=execute]
----
userData: |-
  #cloud-config
  user: centos
  password: ${CLOUD_USER_PASSWORD}
  chpasswd: { expire: False }
  packages:
  - mariadb-server
  runcmd:
  - systemctl enable mariadb
  - systemctl start mariadb
----
+
image::module-07-tempinst/10_Cloud_Init_Script.png[link=self, window=blank, width=100%]

. *Save* ボタンをクリックし、次に *Apply* ボタンをクリックします。

. 次に、左側の *Virtualization* -> *Catalog* メニューをクリックし、*Template catalog* オプションを選択します。作成したテンプレートが、他のすべてのテンプレートと一緒にタイルとして利用できることが確認できるはずです。
+
image::module-07-tempinst/11_User_Templates.png[link=self, window=blank, width=100%]

. タイルをクリックすると、VM起動画面が表示されます。*Quick create VirtualMachine* ボタンをクリックします。
+
image::module-07-tempinst/12_Quick_Create_Template.png[link=self, window=blank, width=100%]

. 仮想マシンが起動すると、*Overview* ページでテンプレートから作成され、定義した追加リソースがあることが確認できます。あとは、*MariaDB* がインストールされていることを確認するだけです。
+
image::module-07-tempinst/13_VM_From_Template.png[link=self, window=blank, width=100%]

. 上部の *Console* タブをクリックし、*Guest login credentials* オプションを使用して仮想マシンのコンソールにログインします。
+
image::module-07-tempinst/14_VM_Console.png[link=self, window=blank, width=100%]

. 仮想マシンにログインしたら、以下のコマンドを実行してMariaDBのインストールをテストします。
+
[source,sh,role=execute]
----
sudo mysql -u root
----
+
image::module-07-tempinst/15_MariaDB_Login.png[link=self, window=blank, width=100%]

. `Ctrl-D` を2回押してVMからログアウトする。

[[create_win]]
== Windows VMテンプレートの作成

このラボのこのセグメントでは、Web サーバー上でホストされている ISO を使用して Microsoft Windows Server 2019 をインストールします。これは、Web サーバー、オブジェクトストレージ、またはクラスタ内の他の永続ボリュームなど、多くの場所からディスクをソースとする機能を利用する仮想マシンにオペレーティングシステムをインストールする方法の 1 つです。

このプロセスは、最初のオペレーティングシステムのインストール後に、他のテンプレートで使用するために、シスプリされた仮想マシンからクローンされたルートディスクを作成することによって合理化できます。

NOTE: テンプレートとして使用するゲストOSを準備する具体的なプロセスは異なります。テンプレートOSを準備する場合は、必ず組織のガイドラインと要件に従ってください。

IMPORTANT: ラボのこの部分では、*vmexamples-{user}* プロジェクト内にいることを確認してください。


. 左側のメニューから、*Virtualization* -> *Catalog* に移動し、上部にある *Template catalog* タブをクリックします。

. 検索バーに *win* と入力するか、*Microsoft Windows Server 2019 VM* タイルを見つけるまで下にスクロールします。
+
image::module-07-tempinst/16_Windows_2k19_Tile.png[link=self, window=blank, width=100%]

. テンプレートに関連するデフォルトの構成を示すダイアログが表示されます。
+
NOTE: 最初はこのVMをクイック作成するオプションがないことに注意してください。
+
image::module-07-tempinst/17_Windows_2k19_Dialog.png[link=self,window=blank,width=100%]
+
. このダイアログでは
.. *win-sysprep* という名前を指定します。
.. チェックボックス *CDから起動* を有効にする。
.. ドロップダウンメニューからURL *(PVCを作成)* を選択します。
.. *画像のURL* を指定します: https://catalog-item-assets.s3.us-east-2.amazonaws.com/qcow_images/Windows2019.iso
.. CDディスクのサイズを *5GiB* に縮小する。
.. *ディスク・ソース* サイズのディスクをデフォルト値 *60 GiB* に設定したままにする。
.. *Windowsドライバディスクをマウントする* チェックボックスが有効になっていることを確認します。これは、VirtIO 用のドライバーを提供する Windows システムをインストールするために必要です。
+

. オプションの入力が完了したら、下部にある *Customize VirtualMachine* ボタンをクリックして、Template の設定を続行します。
+
image::module-07-tempinst/18_Windows_2k19_Parameters.png[link=self, window=blank, width=100%]

. *VirtualMachineのカスタマイズと作成* 画面で、*ブートモード* オプションの横にある編集ペンシルをクリックします。
+
image::module-07-tempinst/19_Boot_Mode.png[link=self, window=blank, width=100%]

. *ブートモード* メニューがポップアップしたら、ドロップダウンメニューから *BIOS* ブートモードを選択します。
+
image::module-07-tempinst/19a_Boot_BIOS.png[link=self, window=blank, width=100%]

. 次に、*Scripts* タブをクリックし、*Sysprep* セクションまでスクロールダウンして、*Edit* ボタンをクリックします。
+
image::module-07-tempinst/20_Customize_Scripts.png[link=self, window=blank, width=100%]

. 新しいテンプレート用の *Sysprep* アクションを作成するための新しいウィンドウがポップアップ表示されます。
+
image::module-07-tempinst/21_Sysprep.png[link=self, window=blank, width=100%]

. 以下のコードブロックをコピーして、*autounattend.xml* セクションに貼り付けます：
+
[source,xml,role=execute]
----
<?xml version="1.0" encoding="utf-8"?>
<unattend xmlns="urn:schemas-microsoft-com:unattend" xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="urn:schemas-microsoft-com:unattend">
  <settings pass="windowsPE">
    <component name="Microsoft-Windows-Setup" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <DiskConfiguration>
        <Disk wcm:action="add">
          <CreatePartitions>
            <CreatePartition wcm:action="add">
              <Order>1</Order>
              <Extend>true</Extend>
              <Type>Primary</Type>
            </CreatePartition>
          </CreatePartitions>
          <ModifyPartitions>
            <ModifyPartition wcm:action="add">
              <Active>true</Active>
              <Format>NTFS</Format>
              <Label>System</Label>
              <Order>1</Order>
              <PartitionID>1</PartitionID>
            </ModifyPartition>
          </ModifyPartitions>
          <DiskID>0</DiskID>
          <WillWipeDisk>true</WillWipeDisk>
        </Disk>
      </DiskConfiguration>
      <ImageInstall>
        <OSImage>
          <InstallFrom>
            <MetaData wcm:action="add">
              <Key>/IMAGE/NAME</Key>
              <Value>Windows Server 2019 SERVERSTANDARD</Value>
            </MetaData>
          </InstallFrom>
          <InstallTo>
            <DiskID>0</DiskID>
            <PartitionID>1</PartitionID>
          </InstallTo>
        </OSImage>
      </ImageInstall>
      <UserData>
        <AcceptEula>true</AcceptEula>
        <FullName>Administrator</FullName>
        <Organization>My Organization</Organization>
      </UserData>
      <EnableFirewall>false</EnableFirewall>
    </component>
    <component name="Microsoft-Windows-International-Core-WinPE" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <SetupUILanguage>
        <UILanguage>en-US</UILanguage>
      </SetupUILanguage>
      <InputLocale>en-US</InputLocale>
      <SystemLocale>en-US</SystemLocale>
      <UILanguage>en-US</UILanguage>
      <UserLocale>en-US</UserLocale>
    </component>
  </settings>
  <settings pass="offlineServicing">
    <component name="Microsoft-Windows-LUA-Settings" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <EnableLUA>false</EnableLUA>
    </component>
  </settings>
  <settings pass="specialize">
    <component name="Microsoft-Windows-Shell-Setup" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <AutoLogon>
        <Password>
          <Value>R3dh4t1!</Value>
          <PlainText>true</PlainText>
        </Password>
        <Enabled>true</Enabled>
        <LogonCount>999</LogonCount>
        <Username>Administrator</Username>
      </AutoLogon>
      <OOBE>
        <HideEULAPage>true</HideEULAPage>
        <HideLocalAccountScreen>true</HideLocalAccountScreen>
        <HideOnlineAccountScreens>true</HideOnlineAccountScreens>
        <HideWirelessSetupInOOBE>true</HideWirelessSetupInOOBE>
        <NetworkLocation>Work</NetworkLocation>
        <ProtectYourPC>3</ProtectYourPC>
        <SkipMachineOOBE>true</SkipMachineOOBE>
      </OOBE>
      <UserAccounts>
        <LocalAccounts>
          <LocalAccount wcm:action="add">
            <Description>Local Administrator Account</Description>
            <DisplayName>Administrator</DisplayName>
            <Group>Administrators</Group>
            <Name>Administrator</Name>
          </LocalAccount>
        </LocalAccounts>
      </UserAccounts>
      <TimeZone>Eastern Standard Time</TimeZone>
    </component>
  </settings>
  <settings pass="oobeSystem">
    <component name="Microsoft-Windows-International-Core" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <InputLocale>en-US</InputLocale>
      <SystemLocale>en-US</SystemLocale>
      <UILanguage>en-US</UILanguage>
      <UserLocale>en-US</UserLocale>
    </component>
    <component name="Microsoft-Windows-Shell-Setup" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <AutoLogon>
        <Password>
          <Value>R3dh4t1!</Value>
          <PlainText>true</PlainText>
        </Password>
        <Enabled>true</Enabled>
        <LogonCount>999</LogonCount>
        <Username>Administrator</Username>
      </AutoLogon>
      <OOBE>
        <HideEULAPage>true</HideEULAPage>
        <HideLocalAccountScreen>true</HideLocalAccountScreen>
        <HideOnlineAccountScreens>true</HideOnlineAccountScreens>
        <HideWirelessSetupInOOBE>true</HideWirelessSetupInOOBE>
        <NetworkLocation>Work</NetworkLocation>
        <ProtectYourPC>3</ProtectYourPC>
        <SkipMachineOOBE>true</SkipMachineOOBE>
      </OOBE>
      <UserAccounts>
        <LocalAccounts>
          <LocalAccount wcm:action="add">
            <Description>Local Administrator Account</Description>
            <DisplayName>Administrator</DisplayName>
            <Group>Administrators</Group>
            <Name>Administrator</Name>
          </LocalAccount>
        </LocalAccounts>
      </UserAccounts>
      <TimeZone>Eastern Standard Time</TimeZone>
    </component>
  </settings>
</unattend>
----

. コードが貼り付けられたら、ダイアログの *保存* ボタンをクリックします。
+
image::module-07-tempinst/22_Windows_2k19_Sysprep.png[link=self, window=blank, width=100%]

. 画面下部の *Create VirtualMachine* ボタンをクリックします。
+
image::module-07-tempinst/23_Create_VirtualMachine.png[link=self, window=blank, width=100%]

. 仮想マシンはISOイメージのダウンロード、設定、インスタンスの起動によってプロビジョニングプロセスを開始します。
+
image::module-07-tempinst/24_Windows_2k19_Provisioning.png[link=self, window=blank, width=100%]

. このプロセスには数分かかることがあります。ISOダウンロードの進行状況は、*Diagnostics* タブをクリックすることで確認できます。
+
image::module-07-tempinst/25_CD_Import.png[link=self, window=blank, width=100%]

. 数分後、仮想マシンが起動し、ステータスが *Running* に変わります。*Console* タブをクリックして、オートアテンドのインストールプロセスを表示します：
+
image::module-07-tempinst/26_Windows_2k19_Console.png[link=self, window=blank, width=100%]

. VMのインストール・プロセスが完了したら（プロビジョニングに3～5分、起動と設定に約10分かかります）、停止ボタンで電源を切ってください。
+
image::module-07-tempinst/27_Stop_Button.png[link=self, window=blank, width=100%]

. マシンの電源を切った状態で、カスタマイズプロセスを実行することなく、今後のWindowsテンプレートベースのインストールに使えるルートボリュームのクローンを作りたい。

. *vmexamples-{user}* ネームスペースで使用可能なPVCのリストを表示するには、*Storage* -> *PersistentVolumeClaims* をクリックします。
+
image::module-07-tempinst/28_Storage_PVC.png[link=self, window=blank, width=100%]

. 表示されている *windows* PVCを見つけ、右側の3点メニューから *Clone PVC* を選択します。ポップアップするメニューで、新しいPVCに *windows-2k19-sysprep-template* という名前を付け、*アクセスモード* を *共有アクセス(RWX)* に設定し、*Clone* ボタンをクリックします。
+
image::module-07-tempinst/29_Clone_Menu.png[link=self, window=blank, width=100%]

. 一度これを保存しておけば、今後Windows VMを素早く作成するのに使うことができる。

. *仮想化* -> *カタログ* メニューに戻り、*ディスク・ソース* として *PVC(クローンPVC)* のオプションを選択し、クローンする *PVC名* として *Windows-2k19-Sysprep-Template* PVCを選択し、*Quick create VirtualMachine* ボタンをクリックして、新しい仮想マシンをクイック作成するためのブート・ソースとしてこのクローンPVCを使用します。
+
image::module-07-tempinst/30_Windows_Template.png[link=self, window=blank, width=100%]

[[instance_types]]
== インスタンスタイプの紹介

仮想マシンのデプロイプロセスを簡素化するために、OpenShift 4.14からデフォルトの設定メカニズムが変更され、*インスタンスタイプ* の使用が重視されるようになりました。インスタンスタイプは、新しい VM に適用するリソースと特性を定義できる再利用可能なオブジェクトです。カスタム・インスタンス・タイプを定義したり、独自のVMをプロビジョニングする際にOpenShift Virtualizationをインストールした際に含まれる様々なインスタンス・タイプを使用することができます。このセクションでは、インスタンスタイプを使用したVMのプロビジョニングについて説明します。

. 始めるには、左側メニューの *Virtualization* -> *Catalog* をクリックします。デフォルトのカタログ項目が *InstanceType* であることがわかります。
+
image::module-07-tempinst/31_Left_Menu_Catalog.png[link=self, window=blank, width=100%]

. インスタンスタイプを使用する最初のステップは、ブートするボリュームを選択することです。ブートソースを提供するテンプレートと同様に、これらのブートソースは、InstanceType でプロビジョニングされたゲストで使用できます。ブートソースを提供するテンプレートと同様に、これらのブートソースは InstanceType でプロビジョニングされたゲストで使用できます。
+
NOTE: *Add Volume* オプションは、読み取り/書き込みアクセス権を持つプロジェクトに参加していない場合、灰色表示されます。

+
image::module-07-tempinst/32_Volume_Boot.png[link=self, window=blank, width=100%]

. *rhel9* ブートボリュームをクリックして、ブートするボリュームタイプとして選択します。選択すると、イメージ名の左側に小さな青い縦線が表示されます。
+
image::module-07-tempinst/33_Select_RHEL9.png[link=self, window=blank, width=100%]

. 次に、使用するインスタンスタイプを選択します。デフォルトで Red Hat が提供するインスタンスタイプがありますが、自分で作成することもできます。提供されているインスタンスタイプにカーソルを合わせると、その使用目的の説明が表示されます。
+
image::module-07-tempinst/34_Select_InstanceType.png[link=self,window=blank,width=100%]
+
* Red Hat が提供するインスタンスタイプは、以下の用途を想定しています：
** n1: VNF のようなネットワーク集約型のワークロード用に設計されています。
** n1: VNF のようなネットワーク集約型のワークロード向け
** cx1: 計算集約型のワークロード向け
** u1: 最も一般的で「ユニバーサル」なワークロード
** nVidia GPU オペレータを使用する VM 専用。
** m1: メモリ集約型ワークロード向け。

. *Uシリーズ* タイルをクリックすると、一般的なインスタンスタイプ用に定義されたリソースのドロップダウンリストが表示されます。デフォルトのオプションは、*medium: 1 CPUs, 4 GiB Memory* です。これを選択します。
+
image::module-07-tempinst/35_InstanceType_Resources.png[link=self, window=blank, width=100%]

. インスタンスタイプを使用してプロビジョニングするために完了する必要がある最後のセクションは、テンプレートセクションと似ています。仮想マシンの名前を指定し、バッキングディスクに使用するストレージクラスを選択する必要があります。デフォルトでは、仮想マシンの名前が生成され、デフォルトのストレージクラスが選択されます。問題がなければ、*Create VirtualMachine* ボタンをクリックします。
+
image::module-07-tempinst/36_VM_Details.png[link=self, window=blank, width=100%]

. 仮想マシンの概要ページが表示され、インスタンスタイプを使用してプロビジョニングされたVMが稼働していることが確認できます。
+
image::module-07-tempinst/37_VM_Overview.png[link=self, window=blank, width=100%]

[[cleanup]]
== クリーンアップ

次のラボのリソースを節約するために、このモジュールで作成した VM を停止します。

. *仮想化* -> *VirtualMachines* に移動します。
. 環境内のすべての VM を確認するために、アクセスできるすべてのプロジェクトを確認してください。最低限、プロジェクト `vmimported-{user}` と `vmexamples-{user}` を確認してください。
. ステータスが *Running* となっているVMがあれば、右側の3つの点をクリックして *Stop* を選択してください。

これで、すべての VM が *Stop* 状態になるはずである。

== まとめ

このセクションでは、既存のテンプレートをクローンしてカスタマイズし、データベースのような特定のワークロードに使用できるテンプレートを作成する方法を学んだ。また、ブートソースなしで存在する既存の Windows テンプレートの 1 つを設定し、インストールプロセスを自動化する方法を学びました。さらに、特定のワークロード用に仮想マシンをさらにカスタマイズするために、インスタンス・タイプを利用する方法も紹介した。